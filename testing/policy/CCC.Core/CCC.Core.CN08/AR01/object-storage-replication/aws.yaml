name: S3 Cross-Region Replication Configuration
service_type: object-storage
requirement_text: >
  When data is created or modified, the data MUST have a complete and recoverable 
  duplicate that is stored in a physically separate data center.

validity_score: 7
validity_commentary: >
  This query validates S3 cross-region replication (CRR) configuration, which
  ensures data is replicated to a separate AWS region. Strengths:
  - Validates replication rules are configured and enabled
  - CRR provides geographic redundancy
  - Replication is automatic for new objects
  Limitations:
  - Does not verify destination bucket exists and is accessible
  - Does not validate replication lag or sync status
  - Same-region replication (SRR) may not satisfy "physically separate" requirement
  - Existing objects before replication was enabled are not automatically replicated
  - Delete markers and deletions may or may not replicate based on configuration

query: |
  aws s3api get-bucket-replication \
    --bucket ${BUCKET_NAME}

rules:
  - jsonpath: "$.ReplicationConfiguration.Rules[*].Status"
    expected_values:
      - "Enabled"
    validation_rule: "^Enabled$"
    description: >
      Verifies that at least one replication rule is enabled on the bucket.
      Disabled rules do not replicate data.

  - jsonpath: "$.ReplicationConfiguration.Rules[*].Destination.Bucket"
    expected_values: []
    validation_rule: "^arn:aws:s3:::[a-z0-9][a-z0-9.-]{1,61}[a-z0-9]$"
    description: >
      Validates that a destination bucket ARN is configured for replication.
      The destination should be in a different region for geographic redundancy.

  - jsonpath: "$.ReplicationConfiguration.Rules[*].Filter.Prefix"
    expected_values: []
    validation_rule: "^.*$"
    description: >
      Checks the replication filter prefix. An empty prefix means all objects
      are replicated. A specific prefix limits replication to matching objects.

  - jsonpath: "$.ReplicationConfiguration.Rules[*].DeleteMarkerReplication.Status"
    expected_values:
      - "Enabled"
    validation_rule: "^(Enabled|Disabled)$"
    description: >
      Checks if delete marker replication is enabled. When enabled, deletions
      are also replicated to the destination bucket.
