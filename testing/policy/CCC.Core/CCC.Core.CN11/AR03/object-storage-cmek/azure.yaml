name: Azure Storage Customer-Managed Key (CMK) Enforcement
service_type: object-storage
requirement_text: >
  When encrypting data, the service MUST verify that customer-managed encryption 
  keys (CMEKs) are used.

validity_score: 8
validity_commentary: >
  This query validates that Azure Storage Account encryption uses customer-managed
  keys stored in Azure Key Vault rather than Microsoft-managed keys. Strengths:
  - Directly validates encryption key source configuration
  - Key Vault key reference indicates CMK usage
  - Supports both Key Vault and Managed HSM keys
  Limitations:
  - Does not validate the referenced Key Vault key exists
  - Does not verify key rotation policy
  - Does not check Key Vault access policies

query: |
  az storage account show \
    --name ${AzureStorageAccount} \
    --resource-group ${AzureResourceGroup} \
    --query "{keySource: encryption.keySource, keyVaultUri: encryption.keyVaultProperties.keyVaultUri, keyName: encryption.keyVaultProperties.keyName}" \
    --output json

rules:
  - jsonpath: "$.keySource"
    expected_values:
      - "Microsoft.Keyvault"
    validation_rule: "^Microsoft\\.Keyvault$"
    description: >
      Verifies that the storage account uses customer-managed keys from Key Vault,
      not Microsoft-managed keys (Microsoft.Storage).

  - jsonpath: "$.keyVaultUri"
    expected_values: []
    validation_rule: "^https://[a-z0-9-]+\\.vault\\.azure\\.net/?$"
    description: >
      Validates that a Key Vault URI is configured. The presence of a Key Vault
      URI confirms customer-managed key configuration.

  - jsonpath: "$.keyName"
    expected_values: []
    validation_rule: "^.+$"
    description: >
      Validates that a specific key name is configured in the Key Vault.
