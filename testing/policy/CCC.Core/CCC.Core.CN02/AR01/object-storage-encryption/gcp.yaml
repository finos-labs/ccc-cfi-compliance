name: GCP Cloud Storage Bucket Encryption Check
service_type: object-storage
requirement_text: >
  When data is stored, it MUST be encrypted using the latest industry-standard 
  encryption methods.

validity_score: 9
validity_commentary: >
  This query validates GCP Cloud Storage bucket encryption configuration.
  GCP encrypts all data at rest by default using AES-256. Strengths:
  - All GCS data is encrypted by default
  - Supports Google-managed, CMEK, and CSEK keys
  - Validates CMEK configuration when specified
  Limitations:
  - Does not validate KMS key configuration details
  - Does not verify key rotation policies

query: |
  gcloud storage buckets describe gs://${ResourceName} \
    --format=json

rules:
  - jsonpath: "$.encryption.defaultKmsKeyName"
    expected_values: []
    validation_rule: "^(projects/.+/locations/.+/keyRings/.+/cryptoKeys/.+)?$"
    description: >
      Validates the default KMS key for bucket encryption. Empty value means
      Google-managed keys are used. A KMS key path indicates CMEK.

  - jsonpath: "$.storageClass"
    expected_values:
      - "STANDARD"
      - "NEARLINE"
      - "COLDLINE"
      - "ARCHIVE"
    validation_rule: "^(STANDARD|NEARLINE|COLDLINE|ARCHIVE)$"
    description: >
      Confirms the bucket exists with a valid storage class. All storage
      classes use the same encryption (AES-256).
