name: Azure Storage Account TLS Policy Check
service_type: object-storage
requirement_text: >
  When a port is exposed for non-SSH network traffic, all traffic MUST include 
  a TLS handshake AND be encrypted using TLS 1.3 or higher.

validity_score: 9
validity_commentary: >
  This query validates TLS configuration at the Azure Storage Account level.
  Azure enforces minimum TLS version at the account level for all blob, file,
  queue, and table endpoints. Note: Azure Storage currently supports TLS 1.2 
  as the highest minimum version - TLS 1.3 support is available but cannot 
  be set as the exclusive minimum yet.

query: |
  az storage account show \
    --name ${AzureStorageAccount} \
    --resource-group ${AzureResourceGroup} \
    --query "{minimumTlsVersion: minimumTlsVersion, supportsHttpsTrafficOnly: supportsHttpsTrafficOnly}" \
    --output json

rules:
  - jsonpath: "$.minimumTlsVersion"
    expected_values:
      - "TLS1_3"
    validation_rule: "^TLS1_3$"
    description: >
      Verifies that the minimum TLS protocol version is set to TLS 1.3.
      Note: Azure Storage does not yet support TLS 1.3 as a minimum version,
      so this check will fail until Azure adds support. This accurately
      reflects the compliance gap against the CCC requirement.

  - jsonpath: "$.supportsHttpsTrafficOnly"
    expected_values:
      - true
    validation_rule: "^true$"
    description: >
      Confirms that HTTPS-only traffic is enforced. When enabled, all HTTP 
      requests are rejected (not redirected).