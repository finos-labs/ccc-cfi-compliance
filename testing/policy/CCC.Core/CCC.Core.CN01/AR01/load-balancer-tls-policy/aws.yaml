name: ALB TLS 1.3 Security Policy Check
service_type: load-balancer
requirement_text: >
  When a port is exposed for non-SSH network traffic, all traffic MUST include 
  a TLS handshake AND be encrypted using TLS 1.3 or higher.

validity_score: 7
validity_commentary: >
  This query validates TLS policy configuration at the ALB level, which is the primary
  TLS termination point for EC2 workloads. However, there are gaps:
  - Does not validate TLS for direct EC2 connections bypassing the ALB
  - Does not verify that backend traffic (ALB to EC2) is also encrypted
  - Only checks declared policy, not actual TLS negotiation behavior
  - EC2 instances with public IPs exposing HTTPS directly are not covered
  - NLB with TLS listeners would require a separate query

query: |
  aws elbv2 describe-listeners \
    --load-balancer-arn ${LOAD_BALANCER_ARN}

rules:
  - jsonpath: "$.Listeners[?(@.Protocol == 'HTTPS')].SslPolicy"
    expected_values:
      - "ELBSecurityPolicy-TLS13-1-2-2021-06"
      - "ELBSecurityPolicy-TLS13-1-3-2021-06"
      - "ELBSecurityPolicy-TLS13-1-2-Res-2021-06"
      - "ELBSecurityPolicy-TLS13-1-2-Ext1-2021-06"
      - "ELBSecurityPolicy-TLS13-1-2-Ext2-2021-06"
    validation_rule: "^ELBSecurityPolicy-TLS13.*$"
    description: >
      Verifies that all HTTPS listeners use a TLS 1.3 compatible security policy.
      The policy name must start with 'ELBSecurityPolicy-TLS13' to ensure TLS 1.3 
      is the minimum supported version.

  - jsonpath: "$.Listeners[?(@.Protocol == 'HTTPS')].Port"
    expected_values:
      - 443
    validation_rule: "^(443|8443|[0-9]+)$"
    description: >
      Confirms that HTTPS listeners are configured on expected ports. 
      Port 443 is standard, but other ports may be valid for specific use cases.

  - jsonpath: "$.Listeners[?(@.Protocol == 'HTTPS')].Certificates[*].CertificateArn"
    expected_values: []
    validation_rule: "^arn:aws:acm:[a-z0-9-]+:[0-9]+:certificate/[a-f0-9-]+$"
    description: >
      Validates that HTTPS listeners have an ACM certificate attached.
      The ARN format must match the ACM certificate pattern.
