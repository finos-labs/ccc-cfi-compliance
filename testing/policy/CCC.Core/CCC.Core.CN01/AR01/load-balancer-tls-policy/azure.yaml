name: Azure Application Gateway TLS 1.3 Policy Check
service_type: load-balancer
requirement_text: >
  When a port is exposed for non-SSH network traffic, all traffic MUST include 
  a TLS handshake AND be encrypted using TLS 1.3 or higher.

validity_score: 7
validity_commentary: >
  This query validates TLS policy configuration at the Azure Application Gateway level.
  Application Gateway is the primary L7 load balancer for Azure workloads. Gaps include:
  - Does not validate TLS for direct VM connections bypassing the gateway
  - Does not verify that backend traffic is also encrypted
  - Only checks declared policy, not actual TLS negotiation behavior
  - Azure Front Door or API Management would require separate queries
  - Azure Load Balancer (L4) does not terminate TLS

query: |
  az network application-gateway show \
    --name ${ResourceName} \
    --resource-group ${AzureResourceGroup} \
    --query "{sslPolicy: sslPolicy, httpListeners: httpListeners[*].{name: name, protocol: protocol}}" \
    --output json

rules:
  - jsonpath: "$.sslPolicy.minProtocolVersion"
    expected_values:
      - "TLSv1_3"
    validation_rule: "^TLSv1_3$"
    description: >
      Verifies that the minimum TLS protocol version is set to TLS 1.3.
      This ensures all connections use TLS 1.3 or higher.

  - jsonpath: "$.sslPolicy.policyType"
    expected_values:
      - "CustomV2"
      - "Predefined"
    validation_rule: "^(CustomV2|Predefined)$"
    description: >
      Validates the SSL policy type. CustomV2 allows granular control,
      Predefined uses Azure-managed policies.

  - jsonpath: "$.httpListeners[?(@.protocol=='Https')].name"
    expected_values: []
    validation_rule: "^.+$"
    description: >
      Confirms that HTTPS listeners are configured. At least one HTTPS
      listener should exist for secure traffic handling.
