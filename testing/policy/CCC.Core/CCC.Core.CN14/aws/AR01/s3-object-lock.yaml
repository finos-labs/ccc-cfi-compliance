name: S3 Object Lock Configuration (30-day retention)
service_type: object-storage
requirement_text: >
  When backups are created for disaster recovery purposes, the storage mechanism 
  MUST NOT allow modification or deletion within 30 days of creation.

validity_score: 8
validity_commentary: >
  S3 Object Lock provides WORM (Write Once Read Many) protection, preventing
  object deletion or modification for a specified retention period. Strengths:
  - Object Lock is enforced at the S3 service level
  - Supports both Governance and Compliance modes
  - Compliance mode cannot be overridden, even by root
  - Retention period can be set at bucket or object level
  Limitations:
  - Must be enabled at bucket creation (cannot be added later)
  - Does not validate individual object retention settings
  - Governance mode can be overridden with special permissions
  - Legal holds are separate from retention periods

query: |
  aws s3api get-object-lock-configuration \
    --bucket ${BUCKET_NAME}

rules:
  - jsonpath: "$.ObjectLockConfiguration.ObjectLockEnabled"
    expected_values:
      - "Enabled"
    validation_rule: "^Enabled$"
    description: >
      Verifies that Object Lock is enabled on the bucket. This is required
      for any retention or legal hold functionality.

  - jsonpath: "$.ObjectLockConfiguration.Rule.DefaultRetention.Mode"
    expected_values:
      - "COMPLIANCE"
    validation_rule: "^(GOVERNANCE|COMPLIANCE)$"
    description: >
      Validates the retention mode. COMPLIANCE mode provides the strongest
      protection - objects cannot be deleted by any user, including root.
      GOVERNANCE mode allows users with special permissions to override.

  - jsonpath: "$.ObjectLockConfiguration.Rule.DefaultRetention.Days"
    expected_values:
      - 30
    validation_rule: "^[3-9][0-9]|[1-9][0-9]{2,}$"
    description: >
      Validates that the default retention period is at least 30 days.
      The regex matches numbers >= 30. Objects cannot be deleted until
      the retention period expires.
