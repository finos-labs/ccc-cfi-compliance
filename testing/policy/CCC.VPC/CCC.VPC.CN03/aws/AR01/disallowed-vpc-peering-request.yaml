name: Restrict VPC Peering to Authorized Accounts
family: Network Security
control_id: CCC.VPC.CN03
control_title: Restrict VPC Peering to Authorized Accounts
control_objective: >
  Ensure VPC peering connections are only established with explicitly authorized destinations to limit network exposure and enforce boundary controls.
assessment_requirement_id: CCC.VPC.CN03.AR01
assessment_requirement_text: "When a VPC peering connection is requested, the service MUST prevent connections from VPCs that are not explicitly allowed."
test_requirement_category: D
test_rationale: "Verifying that unauthorized VPC peering requests are prevented requires attempting a disallowed peering request to observe enforcement behavior."

service_type: vpc
requirement_text: "When a VPC peering connection is requested, the service MUST prevent connections from VPCs that are not explicitly allowed."

validity_score: 7
validity_commentary: >
  This query attempts to create a VPC peering connection to a peer VPC that is
  intentionally not authorized, and asserts that the request is denied.

  Strengths:
  - Directly exercises the prohibited behavior and observes enforcement
  - Uses `--dry-run` to avoid creating real peering connections during testing
  - Captures both exit code and error output for validation

  Limitations:
  - Requires a known "disallowed" peer VPC ID (and potentially peer account ID)
  - The exact failure mode varies (IAM AccessDenied, SCP denial, org guardrail, etc.)
  - If the environment allows the action, AWS returns a `DryRunOperation` error (which should be treated as a failure for this control)

input_contract:
  required_external:
    - AWS_REGION
    - PEER_VPC_ID
  derived_in_executable_test:
    - REQUESTER_VPC_ID (from in-scope resource UID)
  optional:
    - PEER_OWNER_ID
  execution_notes:
    - REQUESTER_VPC_ID is the in-scope VPC under test (typically mapped from test UID).
    - PEER_VPC_ID must refer to a VPC that is intentionally not authorized for peering.
    - Missing required external inputs should be treated as test setup failure (not N/A).
  outcome_mapping:
    denied_result_examples:
      - AccessDenied
      - UnauthorizedOperation
      - AuthFailure
      - explicit deny
    allowed_result_indicator:
      - DryRunOperation
    decision:
      - Denied result => PASS
      - DryRunOperation (would be allowed) => FAIL

query: |
  # Attempt to create a VPC peering connection to a peer VPC that is NOT allowed.
  # Output is normalized to JSON for rule evaluation.

  if [ -z "${AWS_REGION}" ] || [ -z "${REQUESTER_VPC_ID}" ] || [ -z "${PEER_VPC_ID}" ]; then
    echo "{\"ExitCode\":2,\"DryRunAllowed\":false,\"Stderr\":\"Missing required input(s): AWS_REGION, REQUESTER_VPC_ID, PEER_VPC_ID\"}"
    exit 0
  fi

  set +e
  STDERR_FILE=$(mktemp)
  aws ec2 create-vpc-peering-connection \
    --region ${AWS_REGION} \
    --vpc-id ${REQUESTER_VPC_ID} \
    --peer-vpc-id ${PEER_VPC_ID} \
    ${PEER_OWNER_ID:+--peer-owner-id ${PEER_OWNER_ID}} \
    --dry-run \
    1>/dev/null 2>"${STDERR_FILE}"
  EXIT_CODE=$?
  STDERR_RAW=$(cat "${STDERR_FILE}" | tr -d '\n')
  STDERR_TEXT=$(printf "%s" "${STDERR_RAW}" | sed 's/"/\\"/g')
  DRYRUN_ALLOWED=false
  if echo "${STDERR_RAW}" | grep -q "DryRunOperation"; then
    DRYRUN_ALLOWED=true
  fi
  rm -f "${STDERR_FILE}"
  set -e

  echo "{\"ExitCode\":${EXIT_CODE},\"DryRunAllowed\":${DRYRUN_ALLOWED},\"Stderr\":\"${STDERR_TEXT}\"}"

rules:
  - jsonpath: "$.ExitCode"
    expected_values: []
    validation_rule: "^[1-9][0-9]*$"
    description: >
      The create peering request must be prevented; command should exit non-zero.

  - jsonpath: "$.DryRunAllowed"
    expected_values:
      - false
    validation_rule: "^false$"
    description: >
      DryRunOperation means the action would have been allowed, which is a failure.

  - jsonpath: "$.Stderr"
    expected_values: []
    validation_rule: "(?i)(AccessDenied|UnauthorizedOperation|AuthFailure|not authorized|explicit deny|denied)"
    description: >
      The error output should indicate the request was denied by policy/guardrails.
