name: Restrict Default Network Creation - Default Subnets
family: Network Security
control_id: CCC.VPC.CN01
control_title: Restrict Default Network Creation
control_objective: >
  Restrict the automatic creation of default virtual networks and related resources during subscription initialization to avoid insecure default configurations and enforce custom network policies.
assessment_requirement_id: CCC.VPC.CN01.AR01
assessment_requirement_text: "When a subscription is created, the subscription MUST NOT contain default network resources."
test_requirement_category: P
test_rationale: "Presence or absence of default network resources at subscription creation can be verified via control-plane configuration and inventory metadata without generating traffic or inducing failure."

service_type: vpc
requirement_text: >
  When a subscription is created, the subscription MUST NOT contain default network resources.

validity_score: 6
validity_commentary: >
  This query checks for default subnets associated with the AWS default VPC in a given region.

  Strengths:
  - Uses control-plane inventory (DescribeSubnets) and does not generate traffic
  - Targets default subnets via the `default-for-az=true` flag

  Limitations:
  - AWS accounts commonly include a default VPC (and default subnets) per region unless removed
  - The query derives the default VPC ID first; if no default VPC exists, the check returns an empty list
  - This is a current-state check, not a direct subscription-creation-time proof

query: |
  DEFAULT_VPC_ID=$(aws ec2 describe-vpcs \
    --region ${AWS_REGION} \
    --filters Name=is-default,Values=true \
    --query 'Vpcs[0].VpcId' \
    --output text 2>/dev/null || true)

  if [ -z "${DEFAULT_VPC_ID}" ] || [ "${DEFAULT_VPC_ID}" = "None" ]; then
    echo '{"Subnets":[]}'
  else
    aws ec2 describe-subnets \
      --region ${AWS_REGION} \
      --filters Name=vpc-id,Values=${DEFAULT_VPC_ID} Name=default-for-az,Values=true
  fi

rules:
  - jsonpath: "$.Subnets"
    expected_values: []
    validation_rule: "^\\[\\]$"
    description: >
      A compliant environment should return an empty Subnets array for default subnets.
      If any default subnet is present in the default VPC, the control is not satisfied for that region.
